---
title: "Winter chilling - 2019"
author: "Patrick Snelgar"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(magrittr)
library(scales)
library(tidyverse)
library(here)

if(!dir.exists(here("output"))) {
	dir.create(here("output"))
}

source(here("code/plot-themes.R"))
```

```{r data_import, echo=FALSE, include=FALSE}

current_year <- as.integer(format(Sys.Date(), "%Y"))
oldest_year <- current_year - 10
met_data <- NULL

met_data <-  
	read_csv(here("input/MetWatch Export.csv"), 
			 na = c('-',NA)) %>%
	rename(StationID = 1, StartDate = 2,
		   StopDate = 3, TemperatureMean = 4, 
		   RelativeHumidityMean = 5, RainTotal = 6,
		   RadiationMean = 7, WindSpeedMean = 8) %>%
	mutate(StopDate = dmy_hm(StopDate),
		   Month = month(StopDate),
		   Year = year(StopDate), 
		   DayOfYear = yday(StopDate)) %>%
	filter(Month > 4) %>%
	   mutate(IsBelowSevenC = ifelse(TemperatureMean < 7 & !is.na(TemperatureMean), 1, 0))
				

by_site <- met_data %>%
			group_by(Year, StationID) %>%
			mutate(ChillingHoursCumulative = cumsum(IsBelowSevenC))

richardsonChillTable <- read.csv(here("input/RichardsonChillingTable.csv"))


# by_site %>% filter(`Station ID` == "KER") %>% tail() %>% select(StopDate, temperature, chilling_hours)
# 
# by_site %>% filter(Year == 2019 & Month > 3) %>% select(StopDate, temperature, chilling_hours)


# Check for missing data
met_data %>%
	group_by(StationID) %>%
	filter(year(StopDate) == current_year) %>%
	summarise(d = diff(hour(StopDate))) %>%
	filter(d != 1 & d != -23) %>%
	knitr::kable()

met_data %>%
	group_by(StationID) %>%
	filter(year(StopDate) == current_year) %>%
	summarise(d = c(NA, diff(yday(StopDate))), date = StopDate) %>%
	filter(d > 1 | d < 0) %>%
	knitr::kable()
```

```{r graphs, echo=FALSE}

# numeric tick points for x axis
# only interested in data from April - October
doy_ticks <- 
	by_site%>%
	filter(StationID == "TPK" & (Month > 4 & Month < 10)) %$%
	pretty(x = DayOfYear, n = 7)

# labels for x axis ticks
month_ticks <- format(as.Date(doy_ticks, origin), "%b-%d")

by_site %>% 
	filter(StationID == "TPK" & (Month > 4 & Month < 10) & Year >= oldest_year & !Year == 2017) %>%
		ggplot() +
			geom_line(aes(DayOfYear, ChillingHoursCumulative, colour = factor(Year), size = factor(Year))) + 
			scale_size_manual(values = c(rep(0.5, 9), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green",  "black")) + 
			ggtitle(paste("Cumulative chilling hours - Te Puke", current_year)) +
			ylim(0,1000) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year", caption = "2017 is excluded due to sensor error") + 
			guides(size = FALSE) + 
			theme_bw()


ggsave(paste0("output/Winter chilling - Te Puke ", current_year, ".png"), width = 12, height = 8)

by_site %>% 
	filter(StationID == "KER" & (Month > 4 & Month < 10) & Year >= oldest_year) %>%
		ggplot() +
			geom_line(aes(DayOfYear, ChillingHoursCumulative, colour = factor(Year), size = factor(Year))) + 
			scale_size_manual(values = c(rep(0.5, 10), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green", "cornflowerblue", "black")) + 
			ggtitle(paste("Cumulative chilling hours - Kerikeri", current_year)) +
			ylim(0,1000) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year") + 
			guides(size = FALSE) + 
			theme_bw()


ggsave(paste0("output/Winter chilling - Kerikeri ", current_year, ".png"), width = 12, height = 8)


by_site %>% 
	filter(StationID == "RIR" & (Month > 4 & Month < 10) & Year >= oldest_year) %>%
		ggplot() +
			geom_line(aes(DayOfYear, ChillingHoursCumulative, colour = factor(Year), size = factor(Year))) + 
			scale_size_manual(values = c(rep(0.5, 10), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green", "cornflowerblue", "black")) + 
			ggtitle(paste("Cumulative chilling hours - Riwaka", current_year)) +
			ylim(0,1700) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year") + 
			guides(size = FALSE) + 
			theme_bw()


ggsave(paste0("output/Winter chilling - Riwaka ", current_year, ".png"), width = 12, height = 8)

```

```{r chilling_2018, include=FALSE}

doy_ticks <- by_site%>%
				filter(StationID == "TPK" & (month > 4 & month < 10) & (year >= 2008 & year < 2019)) %$%
				pretty(x = doy, n = 7)

# labels for x axis ticks
month_ticks <- format(as.Date(doy_ticks, origin), "%b-%d")

by_site %>% 
	filter(StationID == "TPK" & (month > 4 & month < 10) & (!year == 2017 & (year >= 2008 & year < 2019))) %>%
		ggplot() +
			geom_line(aes(doy, chilling_hours, colour = factor(year), size = factor(year))) + 
			scale_size_manual(values = c(rep(0.5, 9), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold", "darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green",  "black")) + 
			ggtitle("Cumulative chilling hours - Te Puke 2018") +
			ylim(0,2000) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year", caption = "2017 is excluded due to sensor error") + 
			guides(size = FALSE) + 
			theme_bw()

ggsave("../output/Winter chilling - Te Puke 2018.png", width = 12, height = 8)

by_site %>% 
	filter(`Station ID` == "KER" & (month > 4 & month < 10) & (year >= 2008 & year < 2019)) %>%
		ggplot() +
			geom_line(aes(doy, chilling_hours, colour = factor(year), size = factor(year))) + 
			scale_size_manual(values = c(rep(0.5, 10), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green", "cornflowerblue", "black")) + 
			ggtitle("Cumulative chilling hours - Kerikeri 2018") +
			ylim(0,1500) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year") + 
			guides(size = FALSE) + 
			theme_bw()

ggsave("Winter chilling - Kerikeri 2019.png", width = 12, height = 8)


```


```{r budup_dates, echo = FALSE, include = FALSE}

# G11

early_g11 <- yday(ymd("2019/07/22"))
mid_g11 <- yday(ymd("2019/08/01"))
late_g11 <- yday(ymd("2019/08/07"))
vLate_g11 <- yday(ymd("2019/09/16"))

g11 <- data.frame(doy = c(early_g11, mid_g11, late_g11, vLate_g11))

# R19

early_r19 <- yday(ymd("2019/08/03"))
mid_r19 <- yday(ymd("2019/08/15"))
late_r19 <- yday(ymd("2019/08/21"))
vLate_r19 <- yday(ymd("2019/08/29"))

r19 <- data.frame(doy = c(early_r19, mid_r19, late_r19, vLate_r19))


by_site %>% 
	filter(`Station ID` == "TPK" & year == 2019 & doy %in% c(g11$doy, r19$doy)) %>%
	group_by(doy) %>%
	summarise(temp_max = max(temperature),
			  temp_min = min(temperature),
			  rainfall = sum(`Rain Total`)) %>%
	mutate(date = as.Date(doy, origin = "2018/12/31"))
	

```

```{r richardsonGraphs, echo = FALSE}

by_site %>%

	group_by(Year, `Station ID`) %>%
	filter((Month > 4 & Month < 10) & `Station ID` == "TPK" & !is.na(temperature)) %>%
	mutate(richardsonUnit = richardsonChillTable$value[findInterval(temperature , richardsonChillTable$RangeMax[-7])+1],
		   richardsonChillingHours = cumsum(richardsonUnit)) %>%
	ggplot() +  
		geom_line(aes(DayOfYear, richardsonChillingHours, colour = factor(Year))) 
		labs(colour = "Year") + 
		ggtitle("Richardson Chilling hours - Te Puke")
		
#ggsave("Graphs/Richardson Chilling hours - Te Puke.png", width = 12, height = 8)

by_site %>%

	group_by(Year, `Station ID`) %>%
	filter((Month > 4 & Month < 10) & `Station ID` == "KER" & !is.na(temperature)) %>%
	mutate(richardsonUnit = richardsonChillTable$value[findInterval(temperature , richardsonChillTable$RangeMax[-7])+1],
		   richardsonChillingHours = cumsum(richardsonUnit)) %>%
	ggplot() +  
		geom_line(aes(DayOfYear, richardsonChillingHours, colour = factor(Year))) + 
		labs(colour = "Year") + 
		ggtitle("Richardson Chilling hours - Kerikeri")

```

```{r, hc-alt-2020, include=FALSE}

doy_ticks <- 
	by_site%>%
	filter(StationID == "TPK" & (Month > 4 & Month < 10)) %$%
	pretty(x = DayOfYear, n = 7)

# labels for x axis ticks
month_ticks <- format(as.Date(doy_ticks, origin), "%b-%d")

tpk_2020_graph <- 
	by_site %>% 
	filter(StationID == "TPK" & (Month > 4 & Month < 10) & Year > 2010 & !Year == 2017) %>%
		ggplot() +
			geom_line(aes(DayOfYear, ChillingHoursCumulative, colour = factor(Year), size = factor(Year))) + 
			scale_size_manual(values = c(rep(0.5, 8), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "brown", "purple",
										  "forestgreen", "darkturquoise",  "black")) + 
			ggtitle("Cumulative chilling hours - Te Puke 2020") +
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			scale_y_continuous(breaks = seq(0, 1000, 100), limits = c(0,1000),
							   expand = c(0,0)) +
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year", caption = "2017 is excluded due to sensor error") + 
			guides(size = FALSE) + 
			publish_theme()


ggsave(here("output/Winter chilling (HC-alt) - Te Puke 2020.png"), tpk_2020_graph, width = 12, height = 8)

ker_2020_graph <- 
	by_site %>% 
	filter(StationID == "KER" & (Month > 4 & Month < 10) & Year > 2010) %>%
		ggplot() +
			geom_line(aes(DayOfYear, ChillingHoursCumulative, colour = factor(Year), size = factor(Year))) + 
			scale_size_manual(values = c(rep(0.5, 9), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "brown", "purple",
										  "forestgreen", "darkturquoise", "hotpink",  "black")) + 
			ggtitle("Cumulative chilling hours - Kerikeri 2020") +
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			scale_y_continuous(breaks = seq(0, 1000, 100), limits = c(0,1000),
							   expand = c(0,0)) +
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year") + 
			guides(size = FALSE) + 
			publish_theme()


ggsave(here("output/Winter chilling (HC-alt) - Kerikeri 2020.png"), ker_2020_graph, width = 12, height = 8)

```


```{r rainfall}

# Select only june data
june_rainfall <- 
	met_data %>%
	filter(month(StopDate) == 6) %>%
	group_by(StationID, year(StopDate))
	
# How many 
june_rainfall %>%
	summarise(n = n() / 24)

june_rainfall %<>%
	filter(n() / 24 == 30 | year(StopDate) == current_year) %>%
	group_by(StationID, year(StopDate)) %>%
	summarise(rainfall = sum(RainTotal, na.rm = TRUE)) %>%
	rename(year = 2)

june_rainfall %>%
	filter(StationID == "TPK") %>%
	ggplot() +
		geom_bar(aes(factor(year), rainfall, fill = rainfall), stat = "identity") +
		labs(x = "Year", y = "Total rainfall (mm)") +
		ggtitle("Historical June rainfall - Te Puke") +
		scale_y_continuous(limits = c(0,500)) +
		theme_bw()
		
ggsave(paste0("output/Historical June rainfall - Te Puke ", current_year, ".png"), width = 12, height = 8)

```