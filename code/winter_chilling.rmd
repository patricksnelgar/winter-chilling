---
title: "Winter chilling - 2019"
author: "Patrick Snelgar"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(magrittr)
library(scales)
library(tidyverse)
```

```{r data_import, echo=FALSE, include=FALSE}

current_year <- as.integer(format(Sys.Date(), "%Y"))
oldest_year <- current_year - 10
met_data <- NULL
# read in each file for each year and merge into a single data frame
for (year in oldest_year:current_year) {
	temp_year <-  read_csv(paste("//Tep-file/home$/HRTPXS/My Documents/Data/Metwatch/Yearly/MetWatch Export ", year, ".csv", sep=""), skip = 1, na = '-') %>%
					rename(temperature = 'Temperature Dry Bulb Mean') %>%
					mutate(stop_date = parse_date_time(`Stop Date`, c("Ymd HMS",  "Ymd HM", "dmY HM", "dmY HMS")), 
						   month = month(stop_date),
						   year = year(stop_date), 
						   doy = yday(stop_date)) %>%
					filter(month > 4) %>%
					   mutate(below_seven = ifelse(temperature < 7 & !is.na(temperature), 1, 0))
				
				
met_data %<>% bind_rows(., temp_year)

}

by_site <- met_data %>%
			group_by(year, `Station ID`) %>%
			mutate(chilling_hours = cumsum(below_seven))

richardsonChillTable <- read.csv("RichardsonChillingTable.csv")


# by_site %>% filter(`Station ID` == "KER") %>% tail() %>% select(stop_date, temperature, chilling_hours)
# 
# by_site %>% filter(year == 2019 & month > 3) %>% select(stop_date, temperature, chilling_hours)

```

```{r graphs, echo=FALSE}

#met_data %>% filter(`Station ID` == "TPK") %>%
#				ggplot() + 
#					geom_line(aes(format(stop_date, "%m-%d"), temperature, colour = factor(year)))

# numeric tick points for x axis
# only interested in data from April - October
doy_ticks <- by_site%>%
				filter(`Station ID` == "TPK" & (month > 4 & month < 10)) %$%
				pretty(x = doy, n = 7)

# labels for x axis ticks
month_ticks <- format(as.Date(doy_ticks, origin), "%b-%d")

by_site %>% 
	filter(`Station ID` == "TPK" & (month > 4 & month < 10) & !year == 2017) %>%
		ggplot() +
			geom_line(aes(doy, chilling_hours, colour = factor(year), size = factor(year))) + 
			scale_size_manual(values = c(rep(0.5, 9), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green",  "black")) + 
			ggtitle("Cumulative chilling hours - Te Puke 2019") +
			ylim(0,1000) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year", caption = "2017 is exluded due to sensor error") + 
			guides(size = FALSE) + 
			theme_bw()

ggsave("Winter chilling - Te Puke 2019.png", width = 12, height = 8)

by_site %>% 
	filter(`Station ID` == "KER" & (month > 4 & month < 10)) %>%
		ggplot() +
			geom_line(aes(doy, chilling_hours, colour = factor(year), size = factor(year))) + 
			scale_size_manual(values = c(rep(0.5, 10), 1)) + 
			scale_color_manual(values = c("red", "blue", "gold","darkcyan", "orange", "purple",
										  "forestgreen", "darkturquoise", "green", "cornflowerblue", "black")) + 
			ggtitle("Cumulative chilling hours - Kerikeri 2019") +
			ylim(0,1000) + 
			scale_x_continuous(breaks = doy_ticks, labels = month_ticks) + 
			theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
			labs(x = "Date", y = "Cumulative hours (<7°C)", colour = "Year") + 
			guides(size = FALSE) + 
			theme_bw()

ggsave("Winter chilling - Kerikeri 2019.png", width = 12, height = 8)

```

```{r richardsonGraphs, echo = FALSE}

by_site %>%
	group_by(year, `Station ID`) %>%
	filter((month > 4 & month < 10) & `Station ID` == "TPK" & !is.na(temperature)) %>%
	mutate(richardsonUnit = richardsonChillTable$value[findInterval(temperature , richardsonChillTable$RangeMax[-7])+1],
		   richardsonChillingHours = cumsum(richardsonUnit)) %>%
	ggplot() +  
		geom_line(aes(doy, richardsonChillingHours, colour = factor(year))) + 
		labs(colour = "Year") + 
		ggtitle("Richardson Chilling hours - Te Puke")
		
#ggsave("Graphs/Richardson Chilling hours - Te Puke.png", width = 12, height = 8)

by_site %>%
	group_by(year, `Station ID`) %>%
	filter((month > 4 & month < 10) & `Station ID` == "KER" & !is.na(temperature)) %>%
	mutate(richardsonUnit = richardsonChillTable$value[findInterval(temperature , richardsonChillTable$RangeMax[-7])+1],
		   richardsonChillingHours = cumsum(richardsonUnit)) %>%
	ggplot() +  
		geom_line(aes(doy, richardsonChillingHours, colour = factor(year))) + 
		labs(colour = "Year") + 
		ggtitle("Richardson Chilling hours - Kerikeri")

```